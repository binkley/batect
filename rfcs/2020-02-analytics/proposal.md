# Problem statement

At present, visibility into users' experience with batect is larely driven by bug reports, feature requests and community chat conversations, making remediation quite reactive and making it difficult to quantify the impact of different decisions. Furthermore, the lack of data on users, their behaviour and environments makes it difficult to make data-driven decisions about features and prioritisation.



# Proposed solution

As an initial step, this RFC proposes collecting information about batect and the environment it is running in as well as statistical information about how it is used and how it performs.



Specifically, the following environmental information would be collected:

* batect version (eg. `0.51.0`)
* OS and version (eg. `Mac OS X 10.15.4 (x86_64)`)
* Docker version (eg. `19.03.8`)
* JVM version (eg. `Oracle Corporation Java HotSpot(TM) 64-Bit Server VM 1.8.0_162`)
* Shell (eg. `bash` or `fish`)
* Terminal type (value of the `TERM` environment variable - eg. `xterm-256color`)
* Whether batect believes it is running on a CI tool, and the name of the CI tool (eg. `GitHub Actions`, `CircleCI` or `Jenkins`)
* A unique, autogenerated user ID used to correlate information across invocations (a [version 4 randomly-generated UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_(random)))



The following usage information would be collected for all commands:

* The command (eg. running a task, upgrading batect or displaying help)
* The total duration of the command
* The time the command started in UTC
* The output mode used (`simple`, `fancy`, `quiet` or `all`) and whether `--no-color` is enabled
* The Docker connection type (Unix socket, Windows named pipe or TCP) and whether `--docker-tls` or `--docker-tls-verify` is set



When a task is run, the following usage information would also be collected:

* The type of container being run (Windows or Linux)
* The type of cache being used (volume or directory)
* The total number of tasks in the project
* The total number of containers in the project
* The total number of configuration variables in the project
* The total number of prerequisite tasks required to execute before executing the main task
* The number of containers started for each task
* The time taken to load the configuration for the project
* The time taken to execute each task
* The time taken to execute each step in each task (eg. pulling or building a image, creating a container, stopping a container, removing a container)



When an exception occurs that batect cannot recover from, the following information would be collected:

* the type of exception (eg. `IOException` or `ContainerCreationFailedException`)
* the stack trace

The exception's message must not be collected as it may contain sensitive or confidential information.



There are also a number of other considerations:

* Users must be able to opt-out on a per-command and global basis
* Organisations must be able to block analytics submission or opt-out on a network level
* Collecting this information must have a minimal performance impact
* We must not collect any personally identifiable information or collect any potentially sensitive or confidential information such as file names or the names or contents of projects, containers, images or tasks



# Details

## Documentation changes

A privacy policy will be added to the documentation to explain what information is collected, how it is collected, who has access to it and how to opt-out or block submission of this information.

[Automattic's privacy policy](https://github.com/Automattic/legalmattic/blob/master/Privacy-Policy.md) is available under a Creative Commons license and could be used as a template.

Opting out or blocking collection of analytics information would be supported through three mechanisms:

* `--disable-analytics` command line flag
* `BATECT_DISABLE_ANALYTICS` environment variable
* Blocking HTTPS traffic to the `api.abacus.batect.dev` domain at a network level (eg. at a proxy)



## CLI changes

`./batect --disable-analytics` would disable both collection of analytics information and submission of cached data from previous invocations.

Setting the `BATECT_DISABLE_ANALYTICS` environment variable to `1` or `true` would have the same result.



## Behaviour changes

### On all runs with analytics enabled

Provided `--disable-analytics` or `BATECT_DISABLE_ANALYTICS` is not set, batect would collect the information described above and write it to disk at `~/.batect/analytics` for upload in the background of subsequent runs (see below).



### On first run with analytics enabled

Provided `--disable-analytics` or `BATECT_DISABLE_ANALYTICS` is not set, and that batect does not detect it is running on CI, batect would show the following informational message the first time it is run:

```
Starting with batect v0.xx, batect collects and reports anonymous environment, usage and performance information.
The data collected during this invocation will not be reported until you run batect again.
More information, including details on what information is collected, how to opt-opt and a formal privacy policy, is available at https://batect.dev/Analytics.html.
```



### On subsequent runs with analytics enabled

In the background upon startup, batect would check for cached information from previous runs written to `~/.batect/analytics`. If any is present, it will upload each run (one at a time) and delete each run after a successful upload. If a run fails to upload and is less than 30 days old, it is left on disk to be retried as part of a subsequent run. If a run fails to upload and is more than 30 days old, it is deleted.

To prevent a malformed run from preventing other runs from being uploaded, the upload order of the cached runs will be randomised.

All data will be uploaded over a HTTPS connection.



### On any run with analytics disabled

If analytics is disabled with `--disable-analytics` or `BATECT_DISABLE_ANALYTICS`, analytics data will not be written to disk, and any cached information will not be uploaded.



### On CI with analytics enabled

Many CI systems operate ephemeral agents, with each new build given a clean agent. While this is great for ensuring consistency of builds, it presents problems for the delayed data reporting mechanism described above - data from previous runs would never be uploaded because it is lost when the agent is destroyed.

To compensate for this, when batect detects that it is running on CI, it would attempt to immediately upload the data at the end of the run and not write it to disk if this succeeds. To prevent this from unnecessarily delaying the CI build, the upload process will be given a short timeout (maximum of 5 seconds) and any errors will cause the upload to be aborted and the data written to disk as per normal instead.



## Impacts on other features

None anticipated.



## Prior art

A summary of the data collection practices of other similar tools:

| Name                      | Data collected                                               | Default state                                                | Notes                                                        |
| ------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| GCP CLI                   | "anonymized `gcloud` command and other Cloud SDK command-line tool executions" ([source](https://cloud.google.com/sdk/usage-statistics)) | [Permission requested on first run](https://cloud.google.com/sdk/usage-statistics) | Privacy policy is global Google privacy policy               |
| Docker Desktop            | "error reports, system version and language as well as Docker Desktop lifecycle information (e.g., starts, stops, resets)" | [Enabled by default, message on first run](https://docs.docker.com/docker-for-windows/#general) | Image in [this section of the documentation](https://docs.docker.com/docker-for-windows/install/#start-docker-desktop) shows first run message, no link to privacy policy |
| IntelliJ                  | Listed at https://www.jetbrains.com/help/idea/settings-usage-statistics.html | Permission requested on first run                            | Mentioned in global [privacy policy](https://www.jetbrains.com/company/privacy.html), settings apply to all JetBrains IDEs |
| [Fork](https://fork.dev/) | Unclear                                                      | [Enabled by default, no message](https://github.com/ForkIssues/Tracker/issues/313) | No privacy policy, can't find details on data collected      |
| SourceTree                | "the number of repos you've interacted with and the provider you're using" ([source](https://community.atlassian.com/t5/Sourcetree-questions/Security-information-about-Sourcetree/qaq-p/1104747#M29899)) | [Permission requested on first run](https://community.atlassian.com/t5/Sourcetree-questions/Security-information-about-Sourcetree/qaq-p/1104747#M29899) | Data collection removed altogether as of v4 (October 2019)   |
| Homebrew                  | Listed at https://docs.brew.sh/Analytics                     | [Enabled by default, message on first run](https://docs.brew.sh/Analytics) | No privacy policy                                            |

